## å‰è¨€

å…¶å®åœ¨åˆšå¼€å§‹å­¦ä¹ `Ajax`çš„æ—¶å€™ï¼Œä¸€ç›´æœ‰ä¸€ä¸ªç–‘é—®ï¼Œåœ¨é¡¹ç›®ä¸šåŠ¡ä¸­æœ‰é‚£ä¹ˆå¤šè¯·æ±‚ï¼Œå½“é‡åˆ°é’ˆå¯¹å¤šä¸ªè¯·æ±‚è¿›è¡Œä¸€äº›ç»Ÿä¸€çš„çš„æ“ä½œçš„æ—¶å€™ï¼Œå¯¹æ¯ä¸€ä¸ªè¯·æ±‚éƒ½å†™ç›¸åŒçš„ä¸œè¥¿ï¼Œå²‚ä¸æ˜¯å¾ˆå¤æ‚ï¼Ÿåæ¥çŸ¥é“äº†æœ‰**è¯·æ±‚æ‹¦æˆªå™¨**å’Œ**å“åº”æ‹¦æˆªå™¨**ï¼Œæ‰æ˜ç™½åŸæ¥å¯ä»¥ç»Ÿä¸€å¤„ç†ã€‚åæ¥ï¼Œè‡ªå·±åšåšå®¢çš„åå°ç®¡ç†ç³»ç»Ÿçš„æ—¶å€™ï¼Œéœ€è¦å°è£…è¯·æ±‚å’Œå“åº”æ‹¦æˆªå™¨ï¼Œå…³äºå¦‚ä½•å¤„ç†å“åº”æ‹¦æˆªæœ‰äº†äº›æ€è·¯ï¼Œäºæ˜¯åœ¨è¿™é‡Œåˆ†äº«ä¸‹ã€‚ï¼ˆç”±äºæ˜¯æ²¡ä»€ä¹ˆç»éªŒçš„å°ç™½ï¼Œå†™çš„ä»£ç å’Œå¤„ç†æ€è·¯å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œè¯·æŒ‡æ­£ğŸ‘‡ï¼‰

## éœ€æ±‚åˆ†æ

æˆ‘çš„åå°ç®¡ç†ç³»ç»Ÿä½¿ç”¨`vue`çš„å•é¡µåº”ç”¨ï¼Œä½¿ç”¨çš„ `http`çš„è¯·æ±‚åº“æ˜¯`axios`ï¼Œå…³äºå®ƒçš„ç”¨æ³•å°±ä¸è¯´äº†ï¼Œè¯·è‡ªè¡Œè°·æ­Œã€‚åœ¨é¡¹ç›®ä¸­å¯¹äºå“åº”çš„å¤„ç†æœ‰å‡ ç‚¹è¯‰æ±‚ï¼š

1. èƒ½å¤Ÿå¯¹ä¸€äº›å“åº”å¼‚å¸¸çš„çŠ¶æ€è¿›è¡Œç»Ÿä¸€å¤„ç†
2. å¯¹äºä¸€äº›éœ€è¦å•ç‹¬å¤„ç†çš„å¼‚å¸¸å¯ä»¥åœ¨ä¸šåŠ¡ä»£ç å¤„å•ç‹¬å¤„ç†
3. é’ˆå¯¹å·²çŸ¥çš„çŠ¶æ€ç å¯ä»¥æœ‰ä¸åŒçš„å“åº”å¤„ç†é€»è¾‘
4. ä»£ç è°ƒè¯•çš„æ—¶å€™ï¼Œå“åº”æ•°æ®ä¸éœ€è¦æ¯æ¬¡éƒ½æ‰‹åŠ¨æ‰“å°åˆ°æ§åˆ¶å°
5. â€¦â€¦

åœ¨ä¸šåŠ¡ä»£ç ä¸­ï¼Œæˆ‘æœŸæœ›çš„å¤„ç†å½¢å¼æ˜¯è¿™æ ·çš„ã€‚

```js
// ä¸šåŠ¡ä»£ç ä¸­å¤„ç†é€»è¾‘
async getTagList() {
    const res = await getTagList()
    if (res.flag) {
      // æ­£ç¡®çš„å“åº”æ—¶çš„å¤„ç†
      this.tags = res.data.map((item) => ({
        text: item.name,
        value: item.id
      }))
      return
    }
    // é”™è¯¯æ—¶çš„å“åº”å¤„ç†ï¼Œæˆ‘åªéœ€å…³æ³¨ä¸šåŠ¡æ•°æ®çš„å¤„ç†ï¼Œä¸€äº›å‹å¥½æç¤ºå°±äº¤ç»™ç»Ÿä¸€å¤„ç†çš„ä»£ç 
    this.tags = []
}
//å•ç‹¬å¤„ç†å¼‚å¸¸ï¼Œå½“æˆ‘éœ€è¦å¯¹å†…éƒ¨å¼‚å¸¸ç è¿›è¡Œå•ç‹¬å¤„ç†çš„æ—¶å€™ï¼Œå¯ä»¥è®¿é—®åˆ°åŸå§‹çš„å“åº”æ•°æ®
const res = await this.login(data)
if (res.rootResponse.code === 2004) {
    this.usernameError.flag = !res.flag
    this.usernameError.msg = res.rootResponse.msg
    return
}
if (res.rootResponse.code === 2007) {
    this.passwordError.flag = !res.flag
    this.passwordError.msg = res.rootResponse.msg
    return
}
```

## ä»£ç å®ç°

- å“åº”æ‹¦æˆªå™¨å¤„çš„ä»£ç 

```js
// å“åº”æ‹¦æˆªå™¨
http.interceptors.response.use(
    // 200çš„å“åº”
  (response) => {
    const result = handleResponse(response)
    // æ‰“å°å“åº”æ§åˆ¶å°
    if (env === 'dev') {
      console.log(result)
    } 
    return result
  },
  // é200çš„å“åº”
  (error) => {
    return handleResponse(error.response)
  }
)
```

- å“åº”å¤„ç†å‡½æ•°çš„å°è£…

```js
// å¼•å…¥å¯¹å„ä¸ªçŠ¶æ€ç çš„å¤„ç†å‡½æ•°
import { handle200, handle401, handle404, handle500 } from './handler'
/**
 * @param {String} flag é»˜è®¤æ ‡å¿—ä½
 * @param {Function} callback å›è°ƒå‡½æ•°
 * @return {Function} å¤„ç†å‡½æ•°
 * å·¥å‚å‡½æ•°ï¼Œåˆ¶é€ å¤„ç†å‡½æ•°
 */
const handler = (flag, callback) => {
  return (response) => {
    const formatRes = {
      data: null,//å¤„ç†åçš„å“åº”æ•°æ®
      rootResponse: response,//åŸå§‹çš„å“åº”æ•°æ®
      flag: flag //æ ‡å¿—ä½ï¼Œå“åº”æˆåŠŸäº†è¿˜æ˜¯å¤±è´¥
    }
    //åˆ©ç”¨å¼•ç”¨ç±»å‹çš„ç‰¹å¾ä¿®æ”¹å†…éƒ¨çš„æ•°æ®
    callback(response, formatRes)
    // è¿”å›æ ¼å¼åŒ–çš„å“åº”æ•°æ®
    return formatRes
  }
}

// åˆ›å»ºå¤„ç†å“åº”çš„å¤„ç†å™¨
const httpExceptionMap = new Map()
// åˆ©ç”¨Mapçš„é”®å€¼å¯ä»¥ä¸ºéå­—ç¬¦ä¸²ç±»å‹ï¼Œæ³¨å†Œå“åº”å¤„ç†å‡½æ•°ï¼Œé’ˆå¯¹æµè§ˆå™¨è¿”å›çš„çŠ¶æ€ç çš„å¤„ç†å‡½æ•°
httpExceptionMap.set(200, handler(true, handle200))
httpExceptionMap.set(400, handler(false, handle500))
httpExceptionMap.set(401, handler(false, handle401))
httpExceptionMap.set(404, handler(false, handle404))
httpExceptionMap.set(500, handler(false, handle500))

// ç»Ÿä¸€å¤„ç†çš„å…¥å£ï¼Œè¿›è¡ŒçŠ¶æ€å¤„ç†çš„åˆ†å‘
const handleResponse = function(response) {
  const resStatus = response.status // è·å–è¿”å›çš„å¤„ç†çš„çŠ¶æ€ç 
  if (httpExceptionMap.has(resStatus)) {
    // å·²çŸ¥é”™è¯¯ï¼Œåˆ†å‘å¤„ç†
    return httpExceptionMap.get(resStatus)(response.data)
  } else {
      // æœªçŸ¥é”™è¯¯ï¼Œç»Ÿä¸€500ï¼ŒæœåŠ¡å™¨é”™è¯¯
    console.log('å‘ç”ŸæœªçŸ¥å“åº”é”™è¯¯ >>', response)
    return handler(false, handle500)(response.data)
  }
}
```

- å†…éƒ¨è‡ªå®šä¹‰å¼‚å¸¸çš„å¤„ç†

```js
import store from '@/store'
// 200
export const handle200 = function(response, formatRes) {
  if (response.code === 200) {
    // å¯¹äºæ­£å¸¸çš„å†…éƒ¨çŠ¶æ€ç ï¼Œç›´æ¥è¿”å›å¤„ç†çš„æ•°æ®å³å¯
    formatRes.data = response.data
    return
  }
  // å¯¹äºå¼‚å¸¸çš„å†…éƒ¨çŠ¶æ€ç ï¼Œéœ€è¦ç»Ÿä¸€å¤„ç†çš„è¿›è¡Œå¤„ç†ï¼Œå¹¶å°†å“åº”çš„æ ‡å¿—ä½ç½®ä¸º false
  if (response.code === 2100) {
    store.dispatch('popup/showSnackbar', [response.msg, 'error'])
  }
  if (response.code === 2005) {
    store.dispatch('popup/showSnackbar', [response.msg, 'error'])
  }
  formatRes.flag = false
}
// 500
export const handle500 = function(response) {
  // å¯¹äºå¼‚å¸¸çš„å“åº”å€¼ç›´æ¥ç»Ÿä¸€å¤„ç†å³å¯
  store.dispatch('popup/showSnackbar', ['æœåŠ¡å™¨é”™è¯¯', 'error', 6000])
}
```

## æ€»ç»“

æ²¡æœ‰ä»€ä¹ˆé«˜æ·±çš„é€»è¾‘ï¼Œåªæ˜¯ä¸€ä¸ªç®€å•çš„å°è£…å¤„ç†çš„å®ç°ï¼Œä½†æ˜¯è¿˜æ˜¯å­˜åœ¨è®¸å¤šä¸è¶³çš„åœ°æ–¹ï¼Œæ¯”å¦‚ï¼Œæ˜¯å¦éœ€è¦ç»Ÿä¸€çš„çš„è¯·æ±‚å¯ä»¥åœ¨ä¸šåŠ¡ä»£ç å¤„æ§åˆ¶ï¼ˆåˆ©ç”¨è¯·æ±‚æ‹¦æˆªå™¨çš„ `config` ï¼‰ç­‰ã€‚ç­‰è‡ªå·±ä»¥åæœ‰äº†æ›´å¥½çš„å¤„ç†æ–¹æ¡ˆå†æ¥æ¥ç€å¼„ã€‚